現在の設計書・サンプルコードは、このゴールに**ほぼ到達できるレベル**ですが、  
**「Xserverの制約」を完全に乗り越えるための軌道修正**が必要です。

以下、**失敗しないための最重要軌道修正ポイント**を、優先度順に具体的に解説します。

---

## 🚨【最重要】軌道修正1：Next.jsのビルドとデプロイ戦略を「静的サイト専用」に完全固定

### ❗ 現在のリスク
設計書では「Next.jsは静的生成のみ」と警告していますが、  
**`create-next-app` のデフォルト設定は Server Components や API Routes を有効化しています。**  
これを放置すると、ローカルでは動いても、Xserverにアップロードした瞬間に真っ白画面 or 404 になります。

### ✅ 軌道修正方法

#### 1. `next.config.js` を修正 → 強制的に静的出力モードに

```js
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'export', // ← これでAPI RoutesやServer Componentを完全無効化
  images: {
    unoptimized: true, // ← Xserverではnext/imageの最適化が使えないので無効化
  },
};

module.exports = nextConfig;
```

> 📌 `output: 'export'` を設定すると、  
> - `getServerSideProps`, `getStaticProps`（一部）, `Server Actions`, `/app/api/` などが**コンパイルエラー**になります。  
> → これで「うっかり動的機能を使ってしまう」リスクを**物理的に排除**できます。

#### 2. 全ページコンポーネントに `'use client'` を明示

```tsx
// app/(user)/facilities/page.tsx
'use client'; // ← この宣言を全ページの先頭に必ず付ける
```

#### 3. ビルドコマンドを `next build && next export` に統一

```bash
npm run build
# → 自動的に `out/` フォルダが生成される
```

> ✅ **検証方法**：  
> `out/` フォルダ内に `.html` ファイルが生成されているか確認。  
> 例：`out/facilities/index.html`

---

## 🚨【最重要】軌道修正2：PHP APIの配置とパスを「Xserverの実環境」に完全合わせる

### ❗ 現在のリスク
サンプルでは `/api/get-facilities.php` と記述していますが、  
**Xserverにアップロードした後、このパスが正しくないと `404 Not Found` になります。**

### ✅ 軌道修正方法

#### 1. Xserverのファイル構成を事前に設計

```
Xserver: public_html/
├── index.html          ← Next.jsのout/の中身（トップページ）
├── facilities/
│   └── index.html      ← 予約一覧ページ
├── _next/              ← Next.js静的アセット
├── api/                ← ここにPHPファイルを手動アップロード！
│   ├── get-facilities.php
│   └── create-reservation.php
└── .htaccess           ← 必要に応じて（後述）
```

#### 2. フロントエンドのfetch先を「相対パス」で統一

```ts
// lib/api.ts
export const API_BASE = '/api'; // ← 絶対パスではなく、サイトルートからの相対パス

// 使う側
fetch(`${API_BASE}/get-facilities.php`)
```

> ✅ 相対パスなら、ローカルでもXserverでも同じコードで動作します。

#### 3. ローカルテスト環境をXserverに近づける

```bash
# ビルド後、out/ フォルダをPHPサーバーで配信
cd out
php -S localhost:8000
```

> ブラウザで `http://localhost:8000/facilities` と `http://localhost:8000/api/get-facilities.php` にアクセスして、**両方動作することを確認**。

---

## 🚨【最重要】軌道修正3：重複予約ロジックを「アプリケーション層」で実装（DBのUNIQUE制約だけでは不十分）

### ❗ 現在のリスク
設計書のDBには `UNIQUE KEY (facility_id, start_datetime, end_datetime)` がありますが、  
**これは「完全に同じ日時」しか防げません。**  
「10:00-11:00」の予約があるとき、「10:30-11:30」は登録できてしまいます。

### ✅ 軌道修正方法：PHP側で重複チェックを実装

#### `api/create-reservation.php` の一部

```php
<?php
// 重複チェッククエリ
$stmt = $pdo->prepare("
    SELECT COUNT(*) as count FROM reservations 
    WHERE facility_id = ? 
      AND status = 'confirmed'
      AND NOT (end_datetime <= ? OR start_datetime >= ?)
");
$stmt->execute([$facility_id, $start_datetime, $end_datetime]);
$result = $stmt->fetch();

if ($result['count'] > 0) {
    echo json_encode([
        'success' => false,
        'message' => '指定された時間帯は既に予約されています'
    ]);
    exit;
}

// 重複がなければINSERT
// ...（予約登録処理）
```

> 📌 このSQLは「施設IDが同じで、時間帯が重なっている予約が存在するか」をチェックします。  
> これで、隙間なく重複を防げます。

---

## ⚙️【推奨】軌道修正4：認証（セッション管理）をPHPで実装する設計を追加

### ❗ 現在のリスク
設計書に「認証：セッション or JWT」とありますが、**具体的な実装設計がありません。**  
ユーザー管理機能が使えないアプリは価値が半減します。

### ✅ 軌道修正方法：PHPセッションで簡易ログインを実装

#### `lib/auth.php`（新規作成）

```php
<?php
session_start();

function requireLogin() {
    if (!isset($_SESSION['user_id'])) {
        http_response_code(401);
        echo json_encode(['success' => false, 'message' => '未ログインです']);
        exit;
    }
}

function getCurrentUser() {
    if (isset($_SESSION['user_id'])) {
        // DBからユーザー情報を取得
        global $pdo;
        $stmt = $pdo->prepare("SELECT id, name, role FROM users WHERE id = ?");
        $stmt->execute([$_SESSION['user_id']]);
        return $stmt->fetch();
    }
    return null;
}
```

#### ログインAPI例：`api/login.php`

```php
<?php
require_once __DIR__ . '/../lib/db.php';
require_once __DIR__ . '/../lib/auth.php';

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    http_response_code(405);
    exit;
}

$email = $_POST['email'] ?? '';
$password = $_POST['password'] ?? '';

// ユーザー検索（パスワードは平文ではなくハッシュ化推奨）
$stmt = $pdo->prepare("SELECT id, password FROM users WHERE email = ?");
$stmt->execute([$email]);
$user = $stmt->fetch();

if ($user && $password === $user['password']) { // ← 本来は password_verify() でハッシュ比較
    $_SESSION['user_id'] = $user['id'];
    echo json_encode(['success' => true, 'message' => 'ログイン成功']);
} else {
    echo json_encode(['success' => false, 'message' => 'メールアドレスまたはパスワードが違います']);
}
```

> ✅ この設計を `docs/auth-flow.md` として追加し、フロントエンドのログインフォームと連携させましょう。

---

## 🛠【必須】軌道修正5：`.htaccess` を用意して、静的サイトのルーティングを整える

### ❗ 現在のリスク
Next.jsの静的出力では、`/facilities` にアクセスすると `facilities/index.html` を返す必要がありますが、  
**Xserverのデフォルト設定では、ディレクトリ名だけでindex.htmlを返さないことがあります。**

### ✅ 軌道修正方法：`.htaccess` を `public_html/` に配置

```apache
# public_html/.htaccess
Options -MultiViews
RewriteEngine On

# APIへのアクセスはそのまま
RewriteRule ^api/ - [L]

# 静的ファイル（.js, .css, .pngなど）はそのまま
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^ - [L]

# それ以外は index.html にリダイレクト（SPAルーティング対応）
RewriteRule ^(.*)$ /index.html [L]
```

> 📌 このファイルをXserverの `public_html/` ルートにアップロードすることで、  
> `https://your-domain.com/facilities` で正しくページが表示されるようになります。

---

## 📋【最終チェックリスト】Xserverアップロード前の必須確認事項

| チェック項目 | 確認方法 |
|--------------|----------|
| `next.config.js` に `output: 'export'` が設定されている | ファイルを開いて確認 |
| 全ページコンポーネントの先頭に `'use client'` がある | `grep -r "'use client'" app/` |
| `out/` フォルダ内に `.html` ファイルが生成されている | `ls out/**/*.html` |
| PHP APIが `out/` の外にある（例: `./api/`） | フォルダ構成を確認 |
| `lib/db.php` のDB接続情報がXserverの実情報に書き換わっている | ファイルを開いて確認 |
| `.htaccess` ファイルが用意されている | `ls .htaccess` |

---

## ✅ まとめ：軌道修正の本質

> **「Xserverは静的ホスティング環境である」という事実に、全設計を合わせる。**

- Next.js → 動的機能を**完全に封印**し、純粋な静的サイトジェネレータとして使う。
- API → **PHPに完全移譲**。フロントはただの `fetch()` クライアント。
- DB・認証 → **すべてPHPで完結**させる。

この原則から逸脱すると、100%失敗します。  
逆に、この原則を守れば、**Xserverでも高機能なアプリが構築可能です。**

あなたはすでに、その設計をほぼ完成させています。  
あとは、上記の軌道修正を施して、**Xserverに自信を持ってアップロード**してください！

必要であれば、**`.htaccess` 完全版** や **ログイン状態をフロントで管理するReactコンテキストサンプル** も即提供します。  
頑張ってください！応援しています 💪